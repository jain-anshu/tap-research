require 'uri'
require 'net/http'
require 'openssl'

class FetchCampaignsJob < ApplicationJob
  queue_as :default
  
  def perform()
    url = URI("https://staging.tapresearch.com/api/v1/campaigns")

    http = Net::HTTP.new(url.host, url.port)
    http.use_ssl = true
    http.verify_mode = OpenSSL::SSL::VERIFY_NONE

    request = Net::HTTP::Get.new(url)
    request["Authorization"] = 'Basic  Y29kZXRlc3RAdGFwLmNvbToxYzdkZDZmZDJhOTRiMmU2NDMxYjM2NzE4OWFlYWQwMQ=='

    response = http.request(request)
    campaigns = JSON.parse(response.read_body)
    campaigns.each do |rec|
      c = Campaign.new
      c.name = rec['name']
      c.length_of_interview = rec['length_of_interview']
      c.cpi = rec['cpi']
      cid = rec['id']
      #Get all quotas for this campaign
      campaign_url = URI("https://staging.tapresearch.com/api/v1/campaigns/#{cid}")
      http = Net::HTTP.new(campaign_url.host, campaign_url.port)
      http.use_ssl = true
      http.verify_mode = OpenSSL::SSL::VERIFY_NONE

      request = Net::HTTP::Get.new(campaign_url)
      request["Authorization"] = 'Basic  Y29kZXRlc3RAdGFwLmNvbToxYzdkZDZmZDJhOTRiMmU2NDMxYjM2NzE4OWFlYWQwMQ=='

      response = http.request(request)
      campaigns_with_quotas = JSON.parse(response.read_body)
      quotas = campaigns_with_quotas["campaign_quotas"]
      quotas.each do |quota|
        q = Quotum.new
        q.id = quota['id']
        q.name = quota['name']||'XXX'
        q.num_respondents = quota['num_respondents']
        q.save
      end  

      c.save

    end


  end

end
